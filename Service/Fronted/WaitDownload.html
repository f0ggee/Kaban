<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filesb — uploading</title>

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                   connect-src 'self';
                   img-src 'self' data:;
                   style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
                   font-src https://fonts.gstatic.com;
                   script-src 'self' 'unsafe-inline';
                   base-uri 'self';
                   form-action 'self'">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#0a0a0a; --text:#d1fae5; --muted:#34d399; --border:#064e3b;
      --primary:#10b981; --primary-press:#059669; --danger:#dc2626;
    }
    html,body{
      height:100%;margin:0;background:var(--bg);
      color:var(--text);font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .container{
      height:100vh;display:flex;align-items:center;justify-content:center;
      flex-direction:column;text-align:center;padding:0 20px;
    }
    h1{font-size:28px;font-weight:700;color:var(--primary);margin-bottom:12px;}
    p{color:var(--muted);font-size:18px;margin:0 0 28px;}

    .loader{display:inline-flex;gap:6px;}
    .dot{
      width:12px;height:12px;border-radius:50%;
      background:var(--primary);
      opacity:0.3;
      animation:bounce 1.2s infinite ease-in-out;
    }
    .dot:nth-child(1){animation-delay:0s;}
    .dot:nth-child(2){animation-delay:0.2s;}
    .dot:nth-child(3){animation-delay:0.4s;}
    @keyframes bounce{
      0%,80%,100%{transform:scale(0.6);opacity:0.3;}
      40%{transform:scale(1);opacity:1;}
    }

    .vpn-hint{
      margin-top:40px;border:2px solid var(--danger);border-radius:10px;
      padding:12px 16px;color:#fca5a5;background:#1a1a1a;font-size:14px;max-width:420px;
    }
  </style>
</head>
<body>
<div class="container" aria-live="polite">
  <h1>Filesb — uploading</h1>
  <p>Please wait, the file is being uploaded</p>

  <div class="loader" aria-hidden="true">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot"></div>
  </div>

  <div class="vpn-hint">
    If you are using a VPN, we recommend disabling it for the site to work properly.
  </div>
</div>

<script>
  /*
    Ожидается, что при переходе на эту страницу
    в sessionStorage будут временно сохранены выбранные файлы
    (JSON-данные из предыдущей страницы Upload).
    Тогда здесь они подставляются в скрытую форму и отправляются на /downloader/api.
  */

  window.addEventListener('DOMContentLoaded', async () => {
    const fileList = sessionStorage.getItem('uploadFiles');
    if (!fileList) {
      console.error('Нет файлов для загрузки');
      return;
    }

    const files = await restoreFilesFromBase64(JSON.parse(fileList));
    const form = document.createElement('form');
    form.method = 'POST';
    form.enctype = 'multipart/form-data';
    form.action = '/downloader/api';
    form.style.display = 'none';

    const dt = new DataTransfer();
    for (const f of files) dt.items.add(f);

    const input = document.createElement('input');
    input.type = 'file';
    input.name = 'file';
    input.multiple = true;
    input.files = dt.files;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
  });

  /* Функция восстановления File из base64-данных, если ты их передаёшь через sessionStorage */
  async function restoreFilesFromBase64(items){
    const arr = [];
    for (const it of items){
      const res = await fetch(it.data);
      const blob = await res.blob();
      arr.push(new File([blob], it.name, { type: it.type }));
    }
    return arr;
  }
</script>
</body>
</html>