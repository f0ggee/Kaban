<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filesb — File Upload</title>

  <!-- CSP можно оставить, fetch и window.open работают -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 connect-src 'self';
                 img-src 'self' data:;
                 style-src 'self' https://fonts.googleapis.com 'unsafe-inline';
                 font-src https://fonts.gstatic.com;
                 script-src 'self' 'unsafe-inline';
                 base-uri 'self';
                 form-action 'self'">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0a0a; --panel:#000; --text:#e5fff4; --muted:#89f0c2; --border:#0f3a2e;
      --primary:#10b981; --primary-press:#059669; --focus:#22c55e; --danger:#dc2626;
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; background:var(--bg); color:var(--text); font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
    a{ color:var(--muted); text-decoration:none; }
    a:hover{ color:var(--text); }

    .container{ max-width:980px; margin:0 auto; padding:24px 16px 64px; }

    .header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; }
    .brand{ font-weight:700; color:var(--primary); font-size:20px; letter-spacing:.4px; }
    .auth{ display:flex; gap:12px; }
    .btn-outline{
      padding:10px 14px; border:1px solid var(--border); border-radius:10px;
      background:#07110e; color:var(--text); font-weight:600; font-size:14px;
      transition:border-color .15s ease, background .15s ease;
    }
    .btn-outline:hover{ border-color:var(--focus); }
    .btn-primary{
      padding:14px 18px; border:none; border-radius:12px; font-weight:700;
      background:var(--primary); color:#00150e; cursor:pointer; font-size:16px;
      transition:background .15s ease, transform .06s ease;
    }
    .btn-primary:hover{ background:var(--primary-press); }
    .btn-primary:active{ transform:translateY(1px); }
    .btn-primary[disabled]{ opacity:.7; cursor:not-allowed; }

    .grid{ display:grid; grid-template-columns: 1.1fr 0.9fr; gap:24px; }
    @media (max-width:860px){ .grid{ grid-template-columns:1fr; } }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px; padding:24px;
      box-shadow:0 0 28px rgba(16,185,129,.12);
    }
    .title{ color:var(--primary); margin:0 0 8px; font-size:26px; font-weight:700; }
    .sub{ color:var(--muted); margin:0 0 18px; }

    .dropzone{
      border:2px dashed #145a42;
      border-radius:14px; padding:26px; text-align:center; background:#06130f;
      transition:border-color .15s ease, background .15s ease;
    }
    .dropzone.dragover{ border-color:var(--focus); background:#072015; }
    .drop-actions{ display:flex; gap:12px; justify-content:center; margin-top:14px; flex-wrap:wrap; }
    .hint{ font-size:13px; color:var(--muted); margin-top:8px; }
    .limit{
      margin-top:10px; font-size:14px; color:var(--danger);
      background:#2b0f0f; border:1px solid #6b1111; padding:10px; border-radius:8px; display:inline-block;
    }

    .file-list{ margin-top:18px; display:grid; gap:10px; }
    .file-item{
      display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center;
      padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:#07110e;
    }
    .file-name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .progress-wrap{ width:220px; display:flex; align-items:center; gap:8px; }
    .progress{
      width:100%; height:10px; border-radius:999px; background:#0c2a22; overflow:hidden;
      border:1px solid #145a42;
    }
    .bar{ height:100%; width:0%; background:var(--primary); }
    .percent{ width:44px; text-align:right; font-size:12px; color:var(--muted); }

    .message{
      margin-top:14px; padding:12px; border-radius:10px;
      border:1px solid var(--border); background:#061b14; color:var(--muted); display:none;
    }
    .message.show{ display:block; }
    .message.error{ color:#ffb4b4; border-color:#6b1111; background:#3b0b0b; }

    .side .list{ margin:10px 0 0; padding-left:18px; color:var(--muted); }
    .side .list li{ margin:6px 0; }
    .footer{ margin-top:28px; text-align:center; font-size:12px; color:var(--muted); opacity:.8; }

    /* ===== Loading overlay (как у твоей страницы uploading). Не блокирует pointer events. ===== */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.72); display:none; align-items:center; justify-content:center; z-index:9999; pointer-events:none; }
    .overlay.show{ display:flex; }
    .overlay-panel{
      background:linear-gradient(180deg,#06130f,#000); border:1px solid var(--border);
      border-radius:16px; padding:28px 24px; min-width:280px; max-width:92vw; text-align:center;
      box-shadow:0 0 38px rgba(16,185,129,.18);
    }
    h1.overlay-title{font-size:22px;font-weight:700;color:var(--primary);margin:0 0 8px;}
    p.overlay-sub{color:var(--muted);font-size:15px;margin:0 0 22px;}
    .loader{display:inline-flex;gap:6px;margin-bottom:16px;}
    .dot{ width:12px; height:12px; border-radius:50%; background:var(--primary); opacity:.3; animation:bounce 1.2s infinite ease-in-out; }
    .dot:nth-child(2){animation-delay:.2s;} .dot:nth-child(3){animation-delay:.4s;}
    @keyframes bounce{ 0%,80%,100%{transform:scale(.6);opacity:.3;} 40%{transform:scale(1);opacity:1;} }
    .vpn-hint{ margin-top:8px; border:2px solid var(--danger); border-radius:10px; padding:10px 12px; color:#fca5a5; background:#1a1a1a; font-size:13px; display:inline-block; }
  </style>
</head>
<body>
<div class="container" aria-busy="false">
  <header class="header" aria-label="Site header">
    <div class="brand">Filesb</div>
    <nav class="auth" aria-label="Navigation">
      <a class="btn-outline" href="/profile">Profile</a>
    </nav>
  </header>

  <main class="grid">
    <section class="card" aria-labelledby="up-title">
      <h1 id="up-title" class="title">Загрузка файлов</h1>
      <p class="sub">Выберите файлы и получите ссылку для шаринга</p>

      <div id="dropzone" class="dropzone" tabindex="0" aria-label="Область для перетаскивания файлов">
        Перетащите файлы сюда
        <div class="drop-actions">
          <button id="chooseBtn" class="btn-primary" type="button">Выбрать файлы</button>
          <button id="uploadBtn" class="btn-outline" type="button" disabled>Загрузить</button>
        </div>
        <div class="hint">Можно выбрать несколько файлов</div>
        <div class="limit">Максимальный размер файла: 2 GB</div>
        <input id="fileInput" type="file" multiple hidden />
      </div>

      <div id="fileList" class="file-list" aria-live="polite"></div>
      <div id="message" class="message" role="status"></div>
    </section>

    <aside class="card side" aria-labelledby="info-title">
      <h2 id="info-title" class="title">Почему Filesb</h2>
      <ul class="list">
        <li>Без мессенджеров</li>
        <li>Минималистичный интерфейс</li>
        <li>Мгновенные ссылки на файлы</li>
        <li>Тёмная тема с зелёными акцентами</li>
      </ul>
      <div class="footer">© 2025 Filesb</div>
    </aside>
  </main>
</div>

<!-- Overlay-плашка -->
<div id="overlay" class="overlay" role="status" aria-live="assertive" aria-atomic="true">
  <div class="overlay-panel">
    <h1 class="overlay-title">Filesb — uploading</h1>
    <p class="overlay-sub">Пожалуйста, подождите. Файлы отправляются…</p>
    <div class="loader" aria-hidden="true">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
    <div class="vpn-hint">Если у вас включён VPN, временно отключите его для корректной работы.</div>
  </div>
</div>

<script>
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const chooseBtn = document.getElementById('chooseBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const list = document.getElementById('fileList');
  const message = document.getElementById('message');
  const overlay = document.getElementById('overlay');

  const MAX_SIZE = 5 * 1024 * 1024 * 1024; // 5 GB (UI пишет 2 GB)

  let files = [];

  function showMessage(text, isError=false){
    message.textContent = text;
    message.className = 'message show' + (isError ? ' error' : '');
  }

  function bytesToSize(b){
    if(b === 0) return '0 B';
    const u = ['B','KB','MB','GB','TB'];
    const i = Math.floor(Math.log(b)/Math.log(1024));
    return (b/Math.pow(1024,i)).toFixed(2)+' '+u[i];
  }

  function renderList(){
    list.innerHTML = '';
    files.forEach(file => {
      const row = document.createElement('div');
      row.className = 'file-item';

      const name = document.createElement('div');
      name.className = 'file-name';
      name.textContent = `${file.name} • ${bytesToSize(file.size)}`;

      const wrap = document.createElement('div');
      wrap.className = 'progress-wrap';

      const progress = document.createElement('div');
      progress.className = 'progress';
      const bar = document.createElement('div');
      bar.className = 'bar';
      progress.appendChild(bar);

      const percent = document.createElement('div');
      percent.className = 'percent';
      percent.textContent = '0%';

      wrap.appendChild(progress);
      wrap.appendChild(percent);

      row.appendChild(name);
      row.appendChild(wrap);
      list.appendChild(row);

      file._bar = bar;
      file._percent = percent;
    });

    uploadBtn.disabled = files.length === 0;
  }

  function syncFileInputFromFiles(arrFiles){
    const dt = new DataTransfer();
    for(const f of arrFiles) dt.items.add(f);
    fileInput.files = dt.files;
  }

  function addFiles(fileList){
    const valid = [];
    for(const f of fileList){
      if(f.size > MAX_SIZE){
        showMessage(`Файл ${f.name} превышает лимит 5 ГБ`, true);
        continue;
      }
      valid.push(f);
    }
    files = valid;
    syncFileInputFromFiles(files);
    renderList();
  }

  chooseBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => addFiles(e.target.files));

  ['dragenter','dragover'].forEach(ev =>
          dropzone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); })
  );
  ['dragleave','drop'].forEach(ev =>
          dropzone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); })
  );
  dropzone.addEventListener('drop', e => addFiles(e.dataTransfer.files));

  function showLoadingOverlay(){ overlay.classList.add('show'); }
  function hideLoadingOverlay(){ overlay.classList.remove('show'); }

  // Фоновая отправка через fetch + «пустая» вкладка, открытая синхронно в клике — чтобы редиректы не блокировались
  uploadBtn.addEventListener('click', async () => {
    if (files.length === 0) return;

    showLoadingOverlay();
    showMessage('Идёт загрузка…');

    // Открываем пустую вкладку синхронно — браузер не заблокирует
    const popup = window.open('', '_blank');

    try {
      const formData = new FormData();
      for (const f of files) formData.append('file', f);

      const response = await fetch('/downloader/api', {
        method: 'POST',
        body: formData
        // credentials: 'include', // раскомментируйте, если серверу нужны куки
      });

      if (response.redirected) {
        // Сервер вернул 3xx — переводим ранее открытую вкладку на конечный URL
        if (popup) popup.location = response.url;
        showMessage('Файлы отправлены. Проверьте новую вкладку.');
      } else if (response.ok) {
        // Нет редиректа — покажем ответ как текст
        const text = await response.text();
        if (popup && !popup.closed) {
          popup.document.open();
          popup.document.write(text);
          popup.document.close();
        }
        showMessage('Файлы успешно загружены.');
      } else {
        if (popup && !popup.closed) popup.close();
        showMessage('Ошибка при загрузке: ' + (response.statusText || response.status), true);
      }
    } catch (err) {
      if (popup && !popup.closed) popup.close();
      showMessage('Ошибка: ' + (err.message || err), true);
    } finally {
      hideLoadingOverlay();
    }
  });
</script>
</body>
</html>